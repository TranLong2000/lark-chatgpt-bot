{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "apt-get update && apt-get install -y libtesseract-dev tesseract-ocr tesseract-ocr-eng tesseract-ocr-vie && npm install --omit=dev --no-cache",
    "nodeVersion": "20"
  },
  "deploy": {
    "startCommand": "npm start",
    "numReplicas": 1,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10,
    "healthcheckPath": "/health",
    "healthcheckTimeout": 5000
  }
}
```

### File `.env` đề xuất
Cập nhật để hỗ trợ biến mới (`LARK_BASE_ID`):

```env
LARK_APP_ID=<your_actual_lark_app_id> # Lấy từ Lark Open Platform > Credentials & Basic Info
LARK_APP_SECRET=<your_actual_lark_app_secret> # Lấy từ cùng vị trí
LARK_VERIFICATION_TOKEN=zTPxbQ6ONTk7nXm7aYGJyYqr1UcPQpMFu # Xác nhận
LARK_ENCRYPT_KEY=<new_encrypt_key_from_lark> # Tạo mới (32 ký tự)
LARK_DOMAIN=https://open.larksuite.com
OPENROUTER_API_KEY=<your_openrouter_api_key> # Lấy từ openrouter.ai
BOT_SENDER_ID=<your_bot_sender_id> # Lấy từ Bot Settings
LARK_BASE_ID=<your_lark_base_id> # Lấy từ URL Base trên Lark
PORT=8080
```

### Hướng dẫn triển khai
1. **Cập nhật repository**:
   - Thay `index.js`, `package.json`, `railway.json` bằng code trên trong `TranLong2000/lark-chatgpt-bot`.
   - Chạy:
     ```bash
     npm install
     ```
   - Commit và push:
     ```bash
     git add index.js package.json package-lock.json railway.json
     git commit -m "Add file processing and Lark Base integration"
     git push origin main
     ```

2. **Cập nhật biến môi trường trên Railway**:
   - Vào tab **Variables**, cập nhật:
     ```
     LARK_APP_ID=<your_actual_id>
     LARK_APP_SECRET=<your_key>
     LARK_VERIFICATION_TOKEN=zTPxbQ6ONTk7nXm7aYGJyYqr...
     LARK_ENCRYPT_KEY=<new_encrypt_key> # Tạo mới
     LARK_DOMAIN=https://open.larksuite.com
     OPENROUTER_API_KEY=<your_key>
     BOT_SENDER_ID=<your_bot_id>
     LARK_BASE_ID=<your_base_id> # Nếu dùng Base
     PORT=8080
     ```
   - Lưu và chờ redeploy.

3. **Tạo khóa mã hóa mới**:
   - Truy cập [open.larksuite.com](https://open.larksuite.com), vào **Security Settings**.
   - Tạo mới **Encrypt Key** (32 ký tự), cập nhật vào `.env` và Railway.
   - Nếu vẫn lỗi giải mã, thử tắt mã hóa webhook:
     - Trong **Event Subscriptions**, tắt "Enable Encryption".
     - Test webhook không mã hóa để xác nhận bot hoạt động.

4. **Kiểm tra log**:
   - Gửi tin nhắn, file, hoặc link Base trên Lark.
   - Kiểm tra log trong tab **Deployments**:
     - `Decrypted webhook: ...`
     - `Processing message event`, `Reply sent successfully`
     - Nếu lỗi: `Failed to decrypt webhook`, kiểm tra `LARK_SUBCRYPT_KEY`.
     - Nếu lỗi file: `File Extraction Error` hoặc `Tesseract Error`, kiểm tra cấu hình Tesseract.

5. **Kiểm tra local (tùy chọn)**:
   - Cài phụ thuộc hệ thống (cho Tesseract):
     ```bash
     # Ubuntu/Debian
     sudo apt-get install -y libtesseract-dev tesseract-ocr tesseract-ocr-eng tesseract-ocr-vie
     # macOS
     brew install tesseract tesseract-lang
     ```
   - Cập nhật `.env`, chạy:
     ```bash
     npm install
     npm start
     ```
   - Dùng [ngrok](https://ngrok.com) (`ngrok http 8080`) để test webhook.

### Nếu lỗi
- **Chia sẻ log**: Gửi log sau khi thử với `LARK_SUBCRYPT_KEY` mới hoặc tắt mã hóa.
- **Kiểm tra Tesseract**: Nếu lỗi xử lý ảnh, xác nhận Tesseract được cài đúng.
- **Liên hệ Lark Support**: Nếu giải mã vẫn thất bại, gửi ticket với webhook mẫu và `LARK_SUBCRYPT_KEY` (che một phần) đến [support@lark.com](mailto:support@lark.com).

Hãy cập nhật code, tạo khóa mới, thử tắt mã hóa, và gửi log nếu có lỗi!
